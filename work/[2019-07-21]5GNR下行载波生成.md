利用MATLAB 5G Toolbox生成下行载波
------
5GNR下行信道和信号包括：
- PDSCH和DMRS-PDSCH
- PDCCH和DMRS-PDCCH
- PBCH和DMRS-PBCH
- PSS和SSS

# 波形和载波配置

配置载波频段、带宽、小区ID
```matlab
waveconfig = [];
waveconfig.NCellID = 0;            % 小区ID
waveconfig.ChannelBandwidth = 40;  % 带宽 (MHz)
waveconfig.FrequencyRange = 'FR1'; % 频段 'FR1' or 'FR2'
waveconfig.NumSubframes = 10;      % 每1ms子帧数目
waveconfig.DisplayGrids = 1;       % 是否显示资源网格RG

% 配置载波信息
carriers(1).SubcarrierSpacing = 15;
carriers(1).NRB = 216;
carriers(1).RBStart = 0;

carriers(2).SubcarrierSpacing = 30;
carriers(2).NRB = 106;
carriers(2).RBStart = 1;
```

# SSB

```matlab
% SS burst configuration
ssburst = [];
ssburst.Enable = 1;                     % Enable SS Burst
ssburst.BlockPattern = 'Case B';        % SSB子载波间隔
ssburst.SSBTransmitted = [1 1 1 1];     % 每周期SSB波束
ssburst.SSBPeriodicity = 20;            % SSB周期
ssburst.FrequencySSB = 0*5000;          % 频率偏移，不理解
ssburst.Power = 0;                      % 功率 dB
```

# BWP
![BWP](https://ww2.mathworks.cn/help/examples/5g/win64/xxbwp.png)

```matlab
% Bandwidth parts configurations
bwp = [];

bwp(1).SubcarrierSpacing = 15;          % BWP子载波间隔
bwp(1).CyclicPrefix = 'Normal';         % BWP循环前缀
bwp(1).NRB = 25;                        % BWP大小
bwp(1).RBOffset = 10;                   % BWP位置

bwp(2).SubcarrierSpacing = 30;          
bwp(2).CyclicPrefix = 'Normal';         
bwp(2).NRB = 50;                        
bwp(2).RBOffset = 50;                  
```

# CORESET和搜索空间配置

![BWP](https://ww2.mathworks.cn/help/examples/5g/win64/xxcoresetAlloc.png)

```matlab
% CORESET/search configurations
coreset = [];
coreset(1).AllocatedSymbols = [0,7];    % CORESET起始符号
coreset(1).AllocatedSlots = [0,1];      % CORESET起始slot
coreset(1).AllocatedPeriod = 5;         % CORESET周期 [slot]

coreset(1).Duration = 3;                % CORESET符号数
coreset(1).AllocatedPRB = 6*[0,1,3];    % RB数，101100000
```

# 配置PDCCH
```matlab
pdcch = [];
pdcch(1).Enable = 1;                    % Enable PDCCH sequence
pdcch(1).BWP = 1;                       % Bandwidth part
pdcch(1).Power = 1.1;                   % Power scaling in dB
pdcch(1).EnableCoding = 1;              % Enable DCI coding

pdcch(1).AllocatedSearchSpaces = [0,3]; % ？？？
pdcch(1).CORESET = 1;                   % CORESET ID
pdcch(1).AllocatedPeriod = 4;           % 分配周期？？？

pdcch(1).NumCCE = 8;                    % CCE数目
pdcch(1).StartCCE = 0;                  % 起始CCE

pdcch(1).RNTI = 0;                      % RNTI
pdcch(1).NID = 1;                       % PDCCH和DM-RS扰码ID
pdcch(1).PowerDMRS = 0;                 % Additional power boosting in dB
pdcch(1).DataBlkSize = 20;              % DCI payload size
pdcch(1).DataSource = 'PN9';            % DCI data source
```

# 配置PDSCH

```matlab
pdsch = [];
pdsch(1).Enable = 1;                    % Enable PDSCH sequence
pdsch(1).BWP = 1;                       % Bandwidth part
pdsch(1).Power = 0;                     % Power scaling in dB
pdsch(1).EnableCoding = 1;              % 下行信道编码使能
pdsch(1).DataSource = 'PN9';            % Channel data source
pdsch(1).TargetCodeRate = 0.4785;       % 目标码率
pdsch(1).Xoh_PDSCH = 0;                 % Rate matching overhead
pdsch(1).Modulation = 'QPSK';           % 调制方式'QPSK', '16QAM', '64QAM', '256QAM'
pdsch(1).NLayers = 2;                   % Number of PDSCH layers
pdsch(1).RVSequence = [0,2,3,1];        % ？？？RV sequence to be applied cyclically across the PDSCH allocation sequence
```

```matlab
pdsch(1).AllocatedSymbols = 2:10;      % Range of symbols in a slot
pdsch(1).AllocatedSlots = [0:9];       % Allocated slot indices for PDSCH sequence
pdsch(1).AllocatedPeriod = 15;         % Allocation period in slots (empty implies no repetition)
pdsch(1).AllocatedPRB = [0:5, 10:20];  % PRB allocation
pdsch(1).RNTI = 0;                     % RNTI
pdsch(1).NID = 1;                      % Scrambling for data part
```
![PDSCH分配](https://ww2.mathworks.cn/help/examples/5g/win64/xxpdschAlloc.png)


```matlab
pdsch(1).RateMatch(1).CORESET = [1];                  % Rate matching pattern, defined by CORESET IDs
pdsch(1).RateMatch(1).Pattern.AllocatedPRB = [];      % Rate matching pattern, defined by set of 'bitmaps'
pdsch(1).RateMatch(1).Pattern.AllocatedSymbols = [];
pdsch(1).RateMatch(1).Pattern.AllocatedSlots = [];
pdsch(1).RateMatch(1).Pattern.AllocatedPeriod = [];
```

## PDSCH DMRS配置


```matlab
% Antenna port and DM-RS configuration (TS 38.211 section 7.4.1.1)
pdsch(1).PortSet = 0:pdsch(1).NLayers-1; % DM-RS antenna ports used
pdsch(1).PDSCHMappingType = 'A';         % PDSCH mapping type ('A'(slot-wise),'B'(non slot-wise))
pdsch(1).DMRSTypeAPosition = 2;          % Mapping type A only. First DM-RS symbol position (2,3)
pdsch(1).DMRSLength = 1;                 % Number of front-loaded DM-RS symbols (1(single symbol),2(double symbol))
pdsch(1).DMRSAdditionalPosition = 0;     % Additional DM-RS symbol positions (max range 0...3)
pdsch(1).DMRSConfigurationType = 2;      % DM-RS configuration type (1,2)
pdsch(1).NumCDMGroupsWithoutData = 0;    % CDM groups without data (max range 0...3)
pdsch(1).NIDNSCID = 1;                   % Scrambling identity (0...65535)
pdsch(1).NSCID = 0;                      % Scrambling initialization (0,1)
pdsch(1).PowerDMRS = 0;                  % Additional power boosting in dB
```
## 配置第二个PDSCH

```matlab
pdsch(2) = pdsch(1);
pdsch(2).Enable = 1;
pdsch(2).BWP = 2;                           % PDSCH mapped to 2nd BWP
pdsch(2).AllocatedSymbols = 0:11;
pdsch(2).AllocatedSlots = [2:4,6:20];
pdsch(2).AllocatedPRB = [25:30, 35:38];     % PRB allocation, relative to BWP
```

# 波束生成

```matlab
% Collect together channel oriented parameter sets into a single
% configuration
waveconfig.SSBurst = ssburst;
waveconfig.Carriers = carriers;
waveconfig.BWP = bwp;
waveconfig.CORESET = coreset;
waveconfig.PDCCH = pdcch;
waveconfig.PDSCH = pdsch;

% Generate complex baseband waveform
[waveform,bwpset] = hNRDownlinkWaveformGenerator(waveconfig);
```

![BWP in carrier](https://ww2.mathworks.cn/help/examples/5g/win64/NRDownlinkWaveformGenerationExample_01.png)


![带宽占用](https://ww2.mathworks.cn/help/examples/5g/win64/NRDownlinkWaveformGenerationExample_02.png)

![BWP in carrier](https://ww2.mathworks.cn/help/examples/5g/win64/NRDownlinkWaveformGenerationExample_03.png)